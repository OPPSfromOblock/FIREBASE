<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gurukul Bulk Entries - Bulk Point Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS library for XLSX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #334a6d;
            --danger-color: #d9534f;
            --success-color: #28a745; /* Added for positive points */
            --light-bg: #f0f2f5;
            --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            --text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        body {
            background-color: var(--light-bg);
            font-family: 'Poppins', sans-serif;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            color: var(--primary-color);
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: var(--text-shadow);
        }
        .card {
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            background-color: #fff;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 12px 12px 0 0;
            padding: 15px 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        .card-header i {
            margin-right: 10px;
        }
        .form-label {
            font-weight: 600;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        .table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            padding: 10px 12px;
            font-size: 0.95rem;
        }
        .table td {
            padding: 8px 12px;
            vertical-align: middle;
            font-size: 0.9rem;
        }
        .table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
            transform: scale(1.002);
            transition: all 0.1s ease-in-out;
        }
        .action-section {
            background-color: #f8faff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e6f0ff;
        }
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #d43f3a;
            border-color: #d43f3a;
            transform: translateY(-1px);
        }
        .btn-success { /* Added for positive points button */
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        .btn-success:hover { /* Added for positive points button */
            background-color: #218838;
            border-color: #218838;
            transform: translateY(-1px);
        }
        .form-select, .form-control {
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #ced4da;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
        }
        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.25);
        }
        .update-message {
            margin-top: 15px;
            border-radius: 8px;
            padding: 12px;
            font-weight: 500;
            font-size: 0.95rem;
            display: none;
        }
        .pagination {
            margin-top: 15px;
            margin-bottom: 0;
            justify-content: center;
        }
        .pagination .page-item .page-link {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            border-radius: 6px;
            margin: 0 3px;
            transition: all 0.2s ease-in-out;
        }
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(74, 144, 226, 0.3);
        }
        .pagination .page-item .page-link:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        /* Styles for the new input fields in the table */
        .student-points-input, .student-reason-input {
            width: 100px; /* Adjust as needed */
            display: none; /* Hidden by default */
        }
        .student-reason-input {
            width: 150px; /* Adjust as needed */
        }
        .student-input-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* Loading spinner styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <h1><i class="fas fa-user-slash"></i> Bulk Entries - Bulk Point Management</h1>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-search"></i> Search and Filter Students for Bulk Action
        </div>
        <div class="card-body">
            <div class="search-container mb-3">
                <input class="form-control" id="searchQueryBulk" placeholder="Search by Name, ID, Floor, Room, Class (e.g., X), or Section (e.g., A). You can also search by Class-Section (e.g., X-A)..." type="text" aria-label="Search students for Bulk action" title="Enter student name, ID, floor, room, class, or section to find students for Bulk action."/>
                <i class="fas fa-search" style="position:absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999;"></i>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label" for="BulkFloorFilter">Filter by Floor</label>
                    <select class="form-select" id="BulkFloorFilter" aria-label="Filter by floor" title="Filter students by their floor.">
                        <option value="all">All Floors</option>
                        <option value="1">Floor 1</option>
                        <option value="2">Floor 2</option>
                        <option value="3">Floor 3</option>
                        <option value="4">Floor 4</option>
                        <option value="5">Floor 5</option>
                        <option value="6">Floor 6</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="BulkClassFilter">Filter by Class</label>
                    <input type="text" class="form-control" id="BulkClassFilter" placeholder="e.g., X, IX" aria-label="Filter by class" title="Filter students by their class (e.g., X, IX)."/>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="BulkSectionFilter">Filter by Section</label>
                    <input type="text" class="form-control" id="BulkSectionFilter" placeholder="e.g., A, B" aria-label="Filter by section" title="Filter students by their section (e.g., A, B)."/>
                </div>
            </div>
            <div class="text-end mb-3">
                <button class="btn btn-secondary" id="resetBulkFilters" aria-label="Reset Bulk filters" title="Clear all search and filter settings.">Reset Filters</button>
            </div>
            <div id="BulkFilterDisplay" class="mb-3"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-users"></i> Select Students for Point Action
        </div>
        <div class="card-body">
            <div class="mb-3 form-check">
                <input type="checkbox" id="selectAllBulkStudents" class="form-check-input me-2" aria-label="Select All Visible Students">
                <label for="selectAllBulkStudents" class="form-check-label">Select All Visible Students</label>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Select</th>
                            <th scope="col"><i class="fas fa-id-card"></i> ID</th>
                            <th scope="col"><i class="fas fa-user"></i> Name</th>
                            <th scope="col"><i class="fas fa-door-open"></i> Room</th>
                            <th scope="col"><i class="fas fa-building"></i> Floor</th>
                            <th scope="col"><i class="fas fa-chalkboard"></i> Class</th>
                            <th scope="col"><i class="fas fa-tag"></i> Section</th>
                            <th scope="col"><i class="fas fa-coins"></i> Current Points</th>
                            <th scope="col"><i class="fas fa-exchange-alt"></i> Points to Change</th>
                            <th scope="col"><i class="fas fa-comment-alt"></i> Reason</th>
                        </tr>
                    </thead>
                    <tbody id="BulkStudentsTable">
                        <!-- Students for Bulk deduction/addition will be loaded here -->
                    </tbody>
                </table>
            </div>
            <nav aria-label="Page navigation for Bulk entries">
                <ul class="pagination justify-content-center" id="BulkPagination"></ul>
            </nav>

            <!-- Action Section for common inputs -->
            <div class="action-section mt-4">
                <h4><i class="fas fa-cogs"></i> Bulk Point Action Details</h4>
                <div class="mb-3">
                    <label class="form-label" for="BulkAdminSelector">Modified By (Incharge):</label>
                    <select class="form-select" id="BulkAdminSelector" aria-label="Select incharge for Bulk action" title="Select the incharge who is making this point change.">
                        <option value="">Select Incharge</option>
                        <option value="BHAVESHBHAI JOLIYA">BHAVESHBHAI JOLIYA</option>
                        <option value="PRAVINBHAI SOLANKI">PRAVINBHAI SOLANKI</option>
                        <option value="THIRUPATHI VASANTH REDDY">THIRUPATHI VASANTH REDDY</option>
                        <option value="SUNIL VINAYAK LUTE">SUNIL VINAYAK LUTE</option>
                        <option value="Balaji AshokRao More">Balaji AshokRao More</option>
                        <option value="JOLIYA VIPUL RAMJIBHAI">JOLIYA VIPUL RAMJIBHAI</option>
                        <option value="LALJI TIWARI">LALJI TIWARI</option>
                        <option value="Ranveer Singh">Ranveer Singh</option>
                        <option value="BANOTH VAMSHI">BANOTH VAMSHI</option>
                        <option value="P Ananth Reddy">P Ananth Reddy</option>
                        <option value="AMAN KUMAR">AMAN KUMAR</option>
                        <option value="LOKESH YADAV">LOKESH YADAV</option>
                        <option value="SUNNY SINGH">SUNNY SINGH</option>
                        <option value="Anirudh Kumar">Anirudh Kumar</option>
                        <option value="Gauri Shankar Sah">Gauri Shankar Sah</option>
                        <option value="CHANDAN KUMAR THAKUR">CHANDAN KUMAR THAKUR</option>
                        <option value="BALRAM KUMAR">BALRAM KUMAR</option>
                        <option value="KOTAM HARISH KUMAR REDDY">KOTAM HARISH KUMAR REDDY</option>
                        <option value="M.VITTAL">M.VITTAL</option>
                        <option value="ROHIT KUMAR SINGH">ROHIT KUMAR SINGH</option>
                        <option value="PALLA SOMASANKAR">PALLA SOMASANKAR</option>
                        <option value="PATLOLLA VINAY REDDY">PATLOLLA VINAY REDDY</option>
                        <option value="DESH PANDE AKHIL">DESH PANDE AKHIL</option>
                        <option value="CHAKRADHAR SAHOO">CHAKRADHAR SAHOO</option>
                        <option value="MANISH">MANISH</option>
                        <option value="CH.VINOD KUMAR">CH.VINOD KUMAR</option>
                        <option value="G.SHANKER RAO">G.SHANKER RAO</option>
                        <option value="V.ADITHYA">V.ADITHYA</option>
                        <option value="V.DEVRAJ">V.DEVRAJ</option>
                        <option value="B.GIRI PRASAD">B.GIRI PRASAD</option>
                        <option value="VENU GOPAL KRISHNA">VENU GOPAL KRISHNA</option>
                        <option value="G.NAGARAJU">G.NAGARAJU</option>
                        <option value="ADINARAYANA RAO">ADINARAYANA RAO</option>
                        <option value="SATISH BHALKE">SATISH BHALKE</option>
                        <option value="B.ANIL">B.ANIL</option>
                        <option value="RAJIV">RAJIV</option>
                        <option value="HARI KRISHNA TIWARI">HARI KRISHNA TIWARI</option>
                        <option value="SHIVA KRISHNA">SHIVA KRISHNA</option>
                        <option value="Manoj">Manoj</option>
                        <option value="Testing Admin">Testing admin</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="BulkTeacherAdminName">Teacher's Name (if not an Incharge):</label>
                    <input type="text" class="form-control" id="BulkTeacherAdminName" placeholder="Enter Teacher's Name" aria-label="Teacher's name for Bulk action" title="Enter the name of the teacher making this point change, if applicable."/>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="BulkAdminEmail">Your Email ID:</label>
                    <input type="email" class="form-control" id="BulkAdminEmail" placeholder="Enter your email ID" required readonly aria-label="Your email ID for Bulk action" title="Your email ID will be automatically filled from login."/>
                </div>
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary btn-lg" id="applyBulkPointsBtn" aria-label="Apply points to selected students" title="Apply points to all selected students based on individual inputs.">
                        <i class="fas fa-check-circle"></i> Apply Points
                    </button>
                </div>
                <div class="update-message alert mt-3" id="BulkUpdateMessage" role="alert" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase configuration (use your own config here)
        const firebaseConfig = {
            apiKey: "AIzaSyAsFiadkeL-__gF_Lb5VY2iap4DlatkaX4",
            authDomain: "senior-data-researchinnovation.firebaseapp.com",
            databaseURL: "https://senior-data-researchinnovation-default-rtdb.firebaseio.com",
            projectId: "senior-data-researchinnovation",
            storageBucket: "senior-data-researchinnovation.firebasestorage.app",
            messagingSenderId: "587"
        };

        // Initialize Firebase (if not already initialized)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const auth = firebase.auth();

        let allStudents = [];
        let filteredStudents = [];
        const studentsPerPage = 10;
        let currentPage = 1;
        let currentUserEmail = ''; // To store the logged-in user's email

        // Store selected students and their input values across pages/filters
        // Map: studentId -> { points: value, reason: value }
        const selectedStudentsData = new Map();

        // DOM Elements
        const searchQueryBulk = document.getElementById('searchQueryBulk');
        const BulkFloorFilter = document.getElementById('BulkFloorFilter');
        const BulkClassFilter = document.getElementById('BulkClassFilter');
        const BulkSectionFilter = document.getElementById('BulkSectionFilter');
        const resetBulkFilters = document.getElementById('resetBulkFilters');
        const BulkStudentsTable = document.getElementById('BulkStudentsTable');
        const BulkPagination = document.getElementById('BulkPagination');
        const selectAllBulkStudents = document.getElementById('selectAllBulkStudents');

        // Common Action Elements
        const BulkAdminSelector = document.getElementById('BulkAdminSelector');
        const BulkTeacherAdminName = document.getElementById('BulkTeacherAdminName');
        const BulkAdminEmail = document.getElementById('BulkAdminEmail');
        const applyBulkPointsBtn = document.getElementById('applyBulkPointsBtn');
        const BulkUpdateMessage = document.getElementById('BulkUpdateMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');


        // --- Utility Functions ---

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Function to add a single history entry
        async function addHistoryEntryToFirebase(entry) {
            return database.ref('points_history').push(entry) // Changed to 'points_history' as per your previous code
                .then(() => {
                    console.log("History entry added to Firebase");
                })
                .catch(error => {
                    console.error("Error adding history entry:", error);
                    throw error;
                });
        }

        // --- Event Listeners ---

        // Filter and Search
        searchQueryBulk.addEventListener('input', filterAndDisplayStudents);
        BulkFloorFilter.addEventListener('change', filterAndDisplayStudents);
        BulkClassFilter.addEventListener('input', filterAndDisplayStudents);
        BulkSectionFilter.addEventListener('input', filterAndDisplayStudents);
        resetBulkFilters.addEventListener('click', resetFilters);

        // Select All Checkbox
        selectAllBulkStudents.addEventListener('change', function() {
            const checkboxes = BulkStudentsTable.querySelectorAll('.student-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                toggleStudentInputs(checkbox); // Toggle inputs for each student
                // Update selectedStudentsData for all visible students
                const studentId = checkbox.dataset.id;
                if (checkbox.checked) {
                    // If checked, add to map with default/empty values, will be updated on input change
                    if (!selectedStudentsData.has(studentId)) {
                        selectedStudentsData.set(studentId, { points: '', reason: '' });
                    }
                } else {
                    // If unchecked, remove from map
                    selectedStudentsData.delete(studentId);
                }
            });
        });

        // Apply Points Button
        applyBulkPointsBtn.addEventListener('click', handleBulkPointAction);

        // --- Functions ---

        // Fetch students from Firebase
        function fetchStudents() {
            showLoading();
            database.ref('students').on('value', (snapshot) => {
                allStudents = [];
                snapshot.forEach((childSnapshot) => {
                    const student = childSnapshot.val();
                    student.id = childSnapshot.key; // Store Firebase key as student ID
                    allStudents.push(student);
                });
                filterAndDisplayStudents();
                hideLoading();
            }, (error) => {
                console.error("Error fetching students:", error);
                displayMessage(BulkUpdateMessage, 'Error fetching student data.', 'alert-danger');
                hideLoading();
            });
        }

        // Filter and display students based on search and filters
        function filterAndDisplayStudents() {
            const query = searchQueryBulk.value.toLowerCase().trim();
            const floorFilter = BulkFloorFilter.value;
            const classFilter = BulkClassFilter.value.toLowerCase().trim();
            const sectionFilter = BulkSectionFilter.value.toLowerCase().trim();

            filteredStudents = allStudents.filter(student => {
                const matchesQuery = (
                    student.name.toLowerCase().includes(query) ||
                    student.id.toLowerCase().includes(query) ||
                    (student.room && student.room.toLowerCase().includes(query)) ||
                    (student.floor && student.floor.toString().includes(query)) ||
                    (student.class && student.class.toLowerCase().includes(query)) ||
                    (student.section && student.section.toLowerCase().includes(query)) ||
                    (student.class && student.section && `${student.class.toLowerCase()}-${student.section.toLowerCase()}`.includes(query))
                );

                const matchesFloor = (floorFilter === 'all' || (student.floor && student.floor.toString() === floorFilter));
                const matchesClass = (!classFilter || (student.class && student.class.toLowerCase().includes(classFilter)));
                const matchesSection = (!sectionFilter || (student.section && student.section.toLowerCase().includes(sectionFilter)));

                return matchesQuery && matchesFloor && matchesClass && matchesSection;
            });

            currentPage = 1; // Reset to first page on new filter
            renderStudentsTable();
            renderPagination();
        }

        // Render students in the table
        function renderStudentsTable() {
            BulkStudentsTable.innerHTML = '';
            const startIndex = (currentPage - 1) * studentsPerPage;
            const endIndex = startIndex + studentsPerPage;
            const studentsToDisplay = filteredStudents.slice(startIndex, endIndex);

            if (studentsToDisplay.length === 0) {
                BulkStudentsTable.innerHTML = '<tr><td colspan="10" class="text-center">No students found matching your criteria.</td></tr>';
                return;
            }

            studentsToDisplay.forEach(student => {
                const studentId = student.id;
                const isSelected = selectedStudentsData.has(studentId);
                const savedData = selectedStudentsData.get(studentId) || { points: '', reason: '' };

                const row = BulkStudentsTable.insertRow();
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input student-checkbox" data-id="${studentId}" ${isSelected ? 'checked' : ''}></td>
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${student.room || 'N/A'}</td>
                    <td>${student.floor || 'N/A'}</td>
                    <td>${student.class || 'N/A'}</td>
                    <td>${student.section || 'N/A'}</td>
                    <td>${student.points || 0}</td>
                    <td>
                        <input type="number" class="form-control student-points-input" data-id="${studentId}" placeholder="e.g., -10 or 20" value="${savedData.points}" ${isSelected ? '' : 'style="display: none;" disabled'}>
                    </td>
                    <td>
                        <textarea class="form-control student-reason-input" data-id="${studentId}" rows="1" placeholder="Reason" value="${savedData.reason}" ${isSelected ? '' : 'style="display: none;" disabled'}>${savedData.reason}</textarea>
                    </td>
                `;
                // Add event listener to the newly created checkbox
                const checkbox = row.querySelector('.student-checkbox');
                checkbox.addEventListener('change', function() {
                    toggleStudentInputs(this);
                    // Update selectedStudentsData based on checkbox state
                    if (this.checked) {
                        // If checked, add to map with current input values (or empty if new)
                        const pointsInput = row.querySelector('.student-points-input');
                        const reasonInput = row.querySelector('.student-reason-input');
                        selectedStudentsData.set(studentId, {
                            points: pointsInput.value,
                            reason: reasonInput.value
                        });
                    } else {
                        // If unchecked, remove from map
                        selectedStudentsData.delete(studentId);
                    }
                });

                // Add event listeners for input fields to save their state
                const pointsInput = row.querySelector('.student-points-input');
                const reasonInput = row.querySelector('.student-reason-input');

                pointsInput.addEventListener('input', function() {
                    if (selectedStudentsData.has(studentId)) {
                        const currentData = selectedStudentsData.get(studentId);
                        currentData.points = this.value;
                        selectedStudentsData.set(studentId, currentData);
                    }
                });

                reasonInput.addEventListener('input', function() {
                    if (selectedStudentsData.has(studentId)) {
                        const currentData = selectedStudentsData.get(studentId);
                        currentData.reason = this.value;
                        selectedStudentsData.set(studentId, currentData);
                    }
                });
            });
            // After rendering, check if all visible students are selected to update selectAllBulkStudents checkbox
            updateSelectAllCheckboxState();
        }

        // Function to toggle visibility and enable/disable of points/reason inputs
        function toggleStudentInputs(checkbox) {
            const row = checkbox.closest('tr');
            const pointsInput = row.querySelector('.student-points-input');
            const reasonInput = row.querySelector('.student-reason-input');

            if (checkbox.checked) {
                pointsInput.style.display = 'block';
                reasonInput.style.display = 'block';
                pointsInput.removeAttribute('disabled');
                reasonInput.removeAttribute('disabled');
            } else {
                pointsInput.style.display = 'none';
                reasonInput.style.display = 'none';
                pointsInput.setAttribute('disabled', 'true');
                reasonInput.setAttribute('disabled', 'true');
                // Do NOT clear values here, as they might be needed if the student is re-selected
                // pointsInput.value = '';
                // reasonInput.value = '';
            }
            updateSelectAllCheckboxState();
        }

        // Update the state of the "Select All Visible Students" checkbox
        function updateSelectAllCheckboxState() {
            const visibleCheckboxes = BulkStudentsTable.querySelectorAll('.student-checkbox');
            const checkedVisibleCheckboxes = BulkStudentsTable.querySelectorAll('.student-checkbox:checked');
            if (visibleCheckboxes.length > 0 && visibleCheckboxes.length === checkedVisibleCheckboxes.length) {
                selectAllBulkStudents.checked = true;
            } else {
                selectAllBulkStudents.checked = false;
            }
        }


        // Render pagination controls
        function renderPagination() {
            BulkPagination.innerHTML = '';
            const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) {
                    li.classList.add('active');
                }
                const link = document.createElement('a');
                link.classList.add('page-link');
                link.href = '#';
                link.textContent = i;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderStudentsTable();
                    renderPagination();
                });
                li.appendChild(link);
                BulkPagination.appendChild(li);
            }
        }

        // Reset all filters
        function resetFilters() {
            searchQueryBulk.value = '';
            BulkFloorFilter.value = 'all';
            BulkClassFilter.value = '';
            BulkSectionFilter.value = '';
            // Clear all selected student data when filters are reset
            selectedStudentsData.clear();
            filterAndDisplayStudents();
        }

        // Handle bulk point deduction or addition
        async function handleBulkPointAction() {
            showLoading();
            applyBulkPointsBtn.disabled = true;
            applyBulkPointsBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Applying...';

            // Use selectedStudentsData map for processing
            if (selectedStudentsData.size === 0) {
                displayMessage(BulkUpdateMessage, 'Please select at least one student.', 'alert-warning');
                applyBulkPointsBtn.disabled = false;
                applyBulkPointsBtn.innerHTML = '<i class="fas fa-check-circle"></i> Apply Points';
                hideLoading();
                return;
            }

            const adminName = BulkAdminSelector.value;
            const teacherName = BulkTeacherAdminName.value.trim();
            const adminEmail = BulkAdminEmail.value.trim();

            let modifiedBy = '';
            if (adminName) {
                modifiedBy = adminName;
            } else if (teacherName) {
                modifiedBy = teacherName;
            } else {
                displayMessage(BulkUpdateMessage, 'Please select an Incharge or enter a Teacher\'s Name.', 'alert-warning');
                applyBulkPointsBtn.disabled = false;
                applyBulkPointsBtn.innerHTML = '<i class="fas fa-check-circle"></i> Apply Points';
                hideLoading();
                return;
            }
            modifiedBy += ` (${adminEmail})`; // Append email to the chosen name

            if (!adminEmail) {
                displayMessage(BulkUpdateMessage, 'Your Email ID is required. Please log in again.', 'alert-warning');
                applyBulkPointsBtn.disabled = false;
                applyBulkPointsBtn.innerHTML = '<i class="fas fa-check-circle"></i> Apply Points';
                hideLoading();
                return;
            }

            const updates = {};
            const historyPromises = [];
            const now = new Date();
            const date = now.toLocaleDateString('en-GB');
            const time = now.toLocaleTimeString('en-GB');

            let successfulUpdates = 0;
            let failedUpdates = 0;
            let validationErrors = [];

            // Iterate over the selectedStudentsData map
            for (const [studentId, data] of selectedStudentsData.entries()) {
                const pointsToChange = parseInt(data.points);
                const reason = data.reason.trim();

                // Per-student validation
                if (isNaN(pointsToChange) || data.points === '') {
                    validationErrors.push(`Student ID ${studentId}: Points to Change must be a valid number.`);
                    continue; // Skip this student
                }
                if (!reason) {
                    validationErrors.push(`Student ID ${studentId}: Reason is required.`);
                    continue; // Skip this student
                }

                const studentRef = database.ref(`students/${studentId}`);

                try {
                    const snapshot = await studentRef.once('value');
                    const studentData = snapshot.val();
                    const currentPoints = studentData ? (studentData.points || 0) : 0;
                    const newPoints = currentPoints + pointsToChange;

                    updates[`students/${studentId}/points`] = newPoints;

                    // Prepare history entry
                    const historyEntry = {
                        date: date,
                        time: time,
                        studentId: studentId,
                        name: studentData ? studentData.name : 'Unknown', // Get student name for history
                        action: reason, // Use the custom reason as action
                        pointsChanged: pointsToChange,
                        oldPoints: currentPoints,
                        newPoints: newPoints,
                        modifiedBy: modifiedBy,
                        type: pointsToChange < 0 ? 'deduction' : 'addition'
                    };
                    historyPromises.push(addHistoryEntryToFirebase(historyEntry));

                    successfulUpdates++;

                } catch (error) {
                    console.error(`Error processing student ${studentId}:`, error);
                    failedUpdates++;
                }
            }

            if (validationErrors.length > 0) {
                displayMessage(BulkUpdateMessage, `Validation Errors: ${validationErrors.join('; ')}`, 'alert-danger');
                applyBulkPointsBtn.disabled = false;
                applyBulkPointsBtn.innerHTML = '<i class="fas fa-check-circle"></i> Apply Points';
                hideLoading();
                return;
            }

            if (Object.keys(updates).length > 0) {
                try {
                    await database.ref().update(updates); // Perform all student point updates
                    await Promise.all(historyPromises); // Wait for all history entries to be added

                    displayMessage(BulkUpdateMessage, `Successfully updated points for ${successfulUpdates} students. ${failedUpdates > 0 ? `Failed for ${failedUpdates} students.` : ''}`, 'alert-success');

                    // Clear selectedStudentsData after successful update
                    selectedStudentsData.clear();
                    selectAllBulkStudents.checked = false; // Deselect select all checkbox

                    // Clear common admin inputs (optional, depending on workflow)
                    // BulkAdminSelector.value = '';
                    // BulkTeacherAdminName.value = '';

                    filterAndDisplayStudents(); // Re-render table to show updated points
                } catch (error) {
                    console.error("Error updating points or history in Firebase:", error);
                    displayMessage(BulkUpdateMessage, `Error updating points or history: ${error.message}`, 'alert-danger');
                }
            } else {
                displayMessage(BulkUpdateMessage, 'No valid updates to perform.', 'alert-warning');
            }

            applyBulkPointsBtn.disabled = false;
            applyBulkPointsBtn.innerHTML = '<i class="fas fa-check-circle"></i> Apply Points';
            hideLoading();
        }

        // Display messages
        function displayMessage(element, message, type) {
            element.textContent = message;
            element.className = `update-message alert ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Get current user's email for readonly field
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserEmail = user.email; // Store email globally
                BulkAdminEmail.value = user.email;
            } else {
                currentUserEmail = '';
                BulkAdminEmail.value = '';
                console.warn("User not logged in. Email field will be empty.");
            }
        });

        // Initial fetch and display
        fetchStudents();
    </script>
</body>
</html>
